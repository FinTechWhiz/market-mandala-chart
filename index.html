<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Market Mandala - NEPSE Demo Chart</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; font-family: Arial; }
    #tv_chart_container { width: 100vw; height: 100vh; }
    #controls, .logo {
      position: absolute;
      top: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .logo { left: 10px; font-weight: bold; }
    #controls {
      right: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    input, select, button {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="logo">Market Mandala</div>
  <div id="controls">
    <select id="companySelect">
      <option value="NABIL">NABIL Bank</option>
      <option value="NRIC">Nepal Reinsurance</option>
      <option value="NTC">Nepal Telecom</option>
    </select>
    <select id="chartType">
      <option value="candlestick">Candlestick</option>
      <option value="line">Line</option>
    </select>
    <button id="toggleTheme">Dark Mode</button>
  </div>
  <div id="tv_chart_container"></div>

  <script>
    let dark = false;
    let chart, series, volumeSeries;

    const demoData = {
      NABIL: generateData(100, 140),
      NRIC: generateData(600, 700),
      NTC: generateData(900, 1000)
    };

    function generateData(min, max) {
      const now = Math.floor(Date.now() / 1000);
      const data = [];
      for (let i = 0; i < 30; i++) {
        const t = now - (30 - i) * 86400;
        const o = random(min, max);
        const c = o + random(-10, 10);
        const h = Math.max(o, c) + random(0, 10);
        const l = Math.min(o, c) - random(0, 10);
        const v = random(1000, 10000);
        data.push({ time: t, open: o, high: h, low: l, close: c, volume: v });
      }
      return data;
    }

    function random(min, max) {
      return Math.round(min + Math.random() * (max - min));
    }

    function drawChart(symbol = 'NABIL', type = 'candlestick') {
      const bg = dark ? '#1e1e1e' : '#ffffff';
      const fg = dark ? '#ffffff' : '#000000';

      document.getElementById('tv_chart_container').innerHTML = '';
      chart = LightweightCharts.createChart(document.getElementById('tv_chart_container'), {
        layout: { backgroundColor: bg, textColor: fg },
        width: window.innerWidth,
        height: window.innerHeight,
        timeScale: { timeVisible: true },
      });

      if (type === 'candlestick') {
        series = chart.addCandlestickSeries();
      } else {
        series = chart.addLineSeries();
      }

      volumeSeries = chart.addHistogramSeries({
        priceFormat: { type: 'volume' },
        priceScaleId: '',
        scaleMargins: { top: 0.9, bottom: 0 },
        color: '#26a69a'
      });

      const prices = demoData[symbol].map(d => ({
        time: d.time, open: d.open, high: d.high, low: d.low, close: d.close
      }));

      const volumes = demoData[symbol].map(d => ({
        time: d.time, value: d.volume, color: d.close > d.open ? '#26a69a' : '#ef5350'
      }));

      series.setData(prices);
      volumeSeries.setData(volumes);
    }

    document.getElementById('chartType').addEventListener('change', () => {
      const sym = document.getElementById('companySelect').value;
      const type = document.getElementById('chartType').value;
      drawChart(sym, type);
    });

    document.getElementById('companySelect').addEventListener('change', () => {
      const sym = document.getElementById('companySelect').value;
      const type = document.getElementById('chartType').value;
      drawChart(sym, type);
    });

    document.getElementById('toggleTheme').addEventListener('click', () => {
      dark = !dark;
      drawChart(
        document.getElementById('companySelect').value,
        document.getElementById('chartType').value
      );
      document.getElementById('toggleTheme').innerText = dark ? 'Light Mode' : 'Dark Mode';
    });

    // Initial load
    drawChart();
  </script>
</body>
</html>
